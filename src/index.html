<!DOCTYPE html>
<html>

<head>
    <title>Planner</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="src/style.css">
    <link rel="icon" type="image/x-icon" href="src/images/favicon.ico">
</head>

<body>
    <div id="top_header"></div>
    <div id="main_container"></div>
    <div id="task_editor" style="display: none;">
        <div id="task_editor_card">
            <span>Title:</span>
            <input>
            <button>Create task</button>
        </div>
    </div>
</body>

</html>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // Loading state
        const state = await readState();
        state.buckets?.map(createBucket);
        state.tasks?.map(createTask);

        // Task Editor
        const taskEditor = document.getElementById('task_editor');
        taskEditor.querySelector('button').addEventListener('click', () => {
            const title = taskEditor.querySelector('input').value;
            const bucket = taskEditor.getAttribute('data-bucket');
            createTask({ title, bucket });
            closeTaskEditor();
        });
        taskEditor.addEventListener('click', event => {
            if (event.target === taskEditor) {
                closeTaskEditor();
            }
        });
        document.addEventListener('keyup', event => {
            if (event.key === 'Escape') {
                closeTaskEditor();
            }
        });
    });

    function createElement(tag, attributes, textContent = '') {
        const element = document.createElement(tag);
        Object.entries(attributes).map(([key, value]) => {
            element.setAttribute(key, value);
        });
        element.textContent = textContent;
        return element;
    }

    function createBucket(name) {
        const bucket = createElement('div', { id: `${name}_bucket`, class: 'bucket' });
        const title = createElement('div', { class: 'title' }, name);
        const button = createElement('button', { class: 'create_task' }, '+');
        button.addEventListener('click', () => {
            openTaskEditor({ bucket: name });
        });
        const taskContainer = createElement('div', { class: 'task_container' });
        bucket.append(title, button, taskContainer);
        document.getElementById('main_container').append(bucket);
    }

    function createTask({ title, bucket }) {
        const task = createElement('div', { class: 'task', draggable: 'true' }, title);
        const taskContainer = document.querySelector(`#${bucket}_bucket .task_container`);
        taskContainer.prepend(task);
    }

    function openTaskEditor({ bucket }) {
        const taskEditor = document.getElementById('task_editor');
        taskEditor.setAttribute('data-bucket', bucket);
        task_editor.style.display = '';
    }

    function closeTaskEditor() {
        const taskEditor = document.getElementById('task_editor');
        task_editor.style.display = 'none';
        taskEditor.querySelector('input').value = '';
        taskEditor.removeAttribute('data-bucket');
    }

    // State
    async function readState() {
        const response = await fetch('http://localhost:666/readState');
        return response.json();
    }

    async function writeState(state) {
        await fetch('http://localhost:666/writeState/' + state);
    }
</script>